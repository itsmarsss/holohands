<!DOCTYPE html>
<html>
    <head>
        <title>Hand Tracking</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                background-color: black;
            }
            #container {
                position: relative;
                display: flex;
                justify-content: center;
                align-items: center;
                width: 100%;
                height: 100%;
            }
            #overlay {
                position: absolute;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <div id="container">
            <video
                id="videoFeed"
                autoplay
                playsinline
                style="display: none"
            ></video>
            <canvas id="overlay"></canvas>
        </div>

        <script>
            const video = document.getElementById("videoFeed");
            const canvas = document.getElementById("overlay");
            const ctx = canvas.getContext("2d");
            const ws = new WebSocket("ws://" + window.location.host + "/ws");

            // Colors for different hands
            const handColors = {
                Left: "#FF0000", // Red
                Right: "#00FF00", // Green
            };

            function resizeCanvas() {
                const aspectRatio = 640 / 480;
                const windowAspectRatio =
                    window.innerWidth / window.innerHeight;

                if (windowAspectRatio > aspectRatio) {
                    canvas.width = window.innerHeight * aspectRatio;
                    canvas.height = window.innerHeight;
                } else {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerWidth / aspectRatio;
                }

                canvas.style.width = canvas.width + "px";
                canvas.style.height = canvas.height + "px";
            }

            function drawHand(hand, imgWidth, imgHeight) {
                // Scale coordinates to video feed size
                const scaleX = canvas.width / imgWidth;
                const scaleY = canvas.height / imgHeight;

                // Draw connections
                ctx.strokeStyle = handColors[hand.handedness];
                ctx.lineWidth = 2;
                hand.connections.forEach(([start, end]) => {
                    const startX = hand.landmarks[start][0] * scaleX;
                    const startY = hand.landmarks[start][1] * scaleY;
                    const endX = hand.landmarks[end][0] * scaleX;
                    const endY = hand.landmarks[end][1] * scaleY;

                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                });

                // Draw landmarks
                ctx.fillStyle = handColors[hand.handedness];
                hand.landmarks.forEach((lm) => {
                    ctx.beginPath();
                    ctx.arc(lm[0] * scaleX, lm[1] * scaleY, 3, 0, 2 * Math.PI);
                    ctx.fill();
                });

                // Draw distance and angle between index finger and thumb
                const indexFinger = hand.landmarks[8];
                const thumb = hand.landmarks[4];
                const distance = Math.sqrt(
                    Math.pow((indexFinger[0] - thumb[0]) * scaleX, 2) +
                        Math.pow((indexFinger[1] - thumb[1]) * scaleY, 2)
                );

                const angle =
                    Math.atan2(
                        (indexFinger[1] - thumb[1]) * scaleY,
                        (indexFinger[0] - thumb[0]) * scaleX
                    ) *
                    (180 / Math.PI);

                ctx.strokeStyle = "#0000FF"; // Blue for line
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(indexFinger[0] * scaleX, indexFinger[1] * scaleY);
                ctx.lineTo(thumb[0] * scaleX, thumb[1] * scaleY);
                ctx.stroke();

                ctx.fillStyle = "#0000FF"; // Blue for text
                ctx.font = "16px Arial";
                ctx.fillText(
                    distance.toFixed(2) + "px, " + angle.toFixed(2) + "Â°",
                    (indexFinger[0] * scaleX + thumb[0] * scaleX) / 2,
                    (indexFinger[1] * scaleY + thumb[1] * scaleY) / 2
                );
            }

            // Update the message handler
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                const image = new Image();
                image.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas before drawing
                    ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

                    if (data.hands.length > 0) {
                        data.hands.forEach((hand) => {
                            drawHand(
                                hand,
                                data.image_size.width,
                                data.image_size.height
                            );
                        });
                    }
                };
                image.src = "data:image/jpeg;base64," + data.frame;
            };

            // Handle window resize
            window.addEventListener("resize", resizeCanvas);
            resizeCanvas(); // Initial resize

            // Stream webcam data to the backend
            navigator.mediaDevices
                .getUserMedia({ video: true })
                .then((stream) => {
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        video.play();
                        const sendFrame = () => {
                            const offscreenCanvas =
                                document.createElement("canvas");
                            offscreenCanvas.width = video.videoWidth;
                            offscreenCanvas.height = video.videoHeight;
                            const offscreenCtx =
                                offscreenCanvas.getContext("2d");
                            offscreenCtx.drawImage(
                                video,
                                0,
                                0,
                                offscreenCanvas.width,
                                offscreenCanvas.height
                            );
                            ws.send(
                                offscreenCanvas.toDataURL("image/webp", 0.75)
                            ); // Use WebP format with 75% quality
                            setTimeout(sendFrame, 33); // Aim for ~30 FPS
                        };
                        sendFrame();
                    };
                });
        </script>
    </body>
</html>
