<!DOCTYPE html>
<html>
    <head>
        <title>Hand Tracking</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
            }
            #container {
                position: relative;
                width: 640px;
                height: 480px;
            }
            #videoFeed {
                position: absolute;
                left: 0;
                top: 0;
            }
            #overlay {
                position: absolute;
                left: 0;
                top: 0;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <div id="container">
            <img id="videoFeed" src="" />
            <canvas id="overlay" width="640" height="480"></canvas>
        </div>

        <script>
            const videoFeed = document.getElementById("videoFeed");
            const canvas = document.getElementById("overlay");
            const ctx = canvas.getContext("2d");
            const ws = new WebSocket("ws://" + window.location.host + "/ws");

            // Colors for different hands
            const handColors = {
                Left: "#FF0000", // Red
                Right: "#00FF00", // Green
            };

            function drawHand(hand, imgWidth, imgHeight) {
                // Scale coordinates to video feed size
                const scaleX = canvas.width / imgWidth;
                const scaleY = canvas.height / imgHeight;

                // Draw connections
                ctx.strokeStyle = handColors[hand.handedness];
                ctx.lineWidth = 2;
                hand.connections.forEach(([start, end]) => {
                    const startX = hand.landmarks[start][0] * scaleX;
                    const startY = hand.landmarks[start][1] * scaleY;
                    const endX = hand.landmarks[end][0] * scaleX;
                    const endY = hand.landmarks[end][1] * scaleY;

                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                });

                // Draw landmarks
                ctx.fillStyle = handColors[hand.handedness];
                hand.landmarks.forEach((lm) => {
                    ctx.beginPath();
                    ctx.arc(lm[0] * scaleX, lm[1] * scaleY, 3, 0, 2 * Math.PI);
                    ctx.fill();
                });

                // Draw distance between index finger and thumb
                const indexFinger = hand.landmarks[8];
                const thumb = hand.landmarks[4];
                const distance = Math.sqrt(
                    Math.pow((indexFinger[0] - thumb[0]) * scaleX, 2) +
                        Math.pow((indexFinger[1] - thumb[1]) * scaleY, 2)
                );

                ctx.fillStyle = "#0000FF"; // Blue for distance text
                ctx.font = "16px Arial";
                ctx.fillText(
                    distance.toFixed(2) + "px",
                    (indexFinger[0] * scaleX + thumb[0] * scaleX) / 2,
                    (indexFinger[1] * scaleY + thumb[1] * scaleY) / 2
                );
            }

            // Update the message handler
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                videoFeed.src = "data:image/jpeg;base64," + data.frame;

                ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas before drawing

                if (data.hands.length > 0) {
                    data.hands.forEach((hand) => {
                        drawHand(
                            hand,
                            data.image_size.width,
                            data.image_size.height
                        );
                    });
                }
            };

            // Handle window resize
            window.addEventListener("resize", () => {
                canvas.style.width = videoFeed.clientWidth + "px";
                canvas.style.height = videoFeed.clientHeight + "px";
            });
        </script>
    </body>
</html>
